import { test } from 'node:test';
import assert from 'node:assert/strict';
import { readFileSync } from 'node:fs';
import path from 'node:path';

const pkgPath = path.join(process.cwd(), 'package.json');
const typesPath = path.join(process.cwd(), 'src', 'types', 'database.ts');

function readPackageJson() {
  return JSON.parse(readFileSync(pkgPath, 'utf8'));
}

test('package.json exposes supabase typings generation command', () => {
  const pkg = readPackageJson();
  assert.ok(pkg.scripts?.['supabase:types'], 'Expected package.json to expose supabase:types script');
});

test('package.json CI pipeline runs type generation', () => {
  const pkg = readPackageJson();
  const script = pkg.scripts?.['ci:verify'];
  assert.ok(script, 'Expected package.json to expose ci:verify script');
  assert.match(
    script,
    /supabase:types/,
    'Expected ci:verify script to run supabase:types'
  );
});

test('database.ts types file is generated with Database export', () => {
  const content = readFileSync(typesPath, 'utf8');

  assert.match(
    content,
    /Auto-generated by Supabase/,
    'Expected types file to include auto-generation banner'
  );

  assert.match(
    content,
    /export\s+type\s+Database\s*=/,
    'Expected types file to export Database type'
  );
});
